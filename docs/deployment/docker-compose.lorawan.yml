version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD:-chirpstack}
      - POSTGRES_USER=${DB_USER:-chirpstack}
      - POSTGRES_DB=${DB_NAME:-chirpstack}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis Cache
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  # ChirpStack Gateway Bridge
  chirpstack-gateway-bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    ports:
      - "1700:1700/udp"
    environment:
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883

  # ChirpStack Network Server
  chirpstack-network-server:
    image: chirpstack/chirpstack-network-server:4
    restart: unless-stopped
    environment:
      - POSTGRESQL_DSN=postgres://${DB_USER:-chirpstack}:${DB_PASSWORD:-chirpstack}@postgres:5432/${DB_NAME:-chirpstack}?sslmode=disable
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883

  # ChirpStack Application Server
  chirpstack-application-server:
    image: chirpstack/chirpstack-application-server:4
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - POSTGRESQL_DSN=postgres://${DB_USER:-chirpstack}:${DB_PASSWORD:-chirpstack}@postgres:5432/${DB_NAME:-chirpstack}?sslmode=disable
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
      - EXTERNAL_URL=http://localhost:8080
      - JWT_SECRET=${JWT_SECRET:-change-this-secret}

volumes:
  postgres_data:
  redis_data:
